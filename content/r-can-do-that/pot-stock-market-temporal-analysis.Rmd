---
title: "Temporal (Pot) Stock Analysis"
author: "Corey Pembleton"
date: "August 14, 2018"
output: html_document
slug: pot-stock-market-temporal-analysis
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(janitor)
library(lubridate)
library(readxl)
library(tidyquant)

```

## Pot stocks: boom or bust?

I personally have little or no interest in capital markets, but I have to say they are well-structured quantitative datasets to play with. Over the past two years in Canada there have been interesting political shifts leaning towards, and away from, the legalization of pot across the country. This, I hypothosize, has resulted in interesting market fluctuations as well. 

### What I'm working with

[Matt Dancho & Davis Vaughan](https://github.com/business-science/tidyquant) created the ```tidyquant``` R package, which builds upon the widely-used ```quantmod``` and ```tidyverse``` packages. With ```tidyquant``` I am able to download and process the relevant data. My banker (cough) brother told me to look into the "Horizons Weed ETF", which is an exchange trade fund which holds stocks in some 40 weed companies, which I've used to create an object from, *holdings*. Some of these companies are only available on the Canadian Toronto Stock Exchange, meaning I couldn't dig up their financial data, however I could for the top 10 holdings which are also on NASDAQ, so can work with these.
### Getting the data and Exploratory Data Analysis

```{r, cache=TRUE}
weed_stock_prices <- tq_get(c("GWPH", "IIPR", "INSY", "SMG",
                               "XXII","ZYNE", "CGC", "APHQF", "CRON"),
                             get = "stock.prices", from = "2000-01-01")
```

```tidyquant``` gives me everything I need in a single function, which is remarkable to say the least. ```tq_get()``` allows me to extract stock prices for each of the companies, which, when collecting since the year 2000, gives a nearly 15,000 row dataset of daily stock price changes.

```{r, echo=FALSE, warning=FALSE}
weed_stock_prices %>% 
  group_by(symbol) %>% 
  summarise(`Daily Occurences on Market` = n()) %>% 
  arrange(desc(`Daily Occurences on Market`)) %>% 
  kableExtra::kable() %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), font_size = 10,
                            full_width = FALSE,
                            position = "float_right") %>% 
  kableExtra::footnote(general = "All data from YahooFinance")

```

It looks like there are some new entrants to the market, and some who have been around for a long time; with the larger companies (such as SMG, Miracle Grow) with seemingly more diverse types of business.

![](https://media.giphy.com/media/OzPmk5PUw4TRK/giphy.gif)
Looking below, there is something interesting with the downfall of MiracleGrow, but what's more interesting for this analysis is capturing the time when all stocks in the ETF have data, which looks to be around 2014.

```{r, echo = FALSE}
weed_stock_prices %>% 
  ggplot(aes(x = date, y = close)) +
  geom_line(aes(col = symbol)) +
  theme_tq(base_family = "Lato") +
  scale_x_date(labels = scales::date_format("%Y"), date_breaks = "1 year") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.text = element_text()) +
  ylab("Daily Closing Value (USD)")
```


Looking closer only at the dates beyond 2014, a much more interesting picture of the ETF arises: 

```{r, echo = FALSE}
weed_stock_prices %>%
  filter(date > "2013-12-31") %>% 
  ggplot(aes(x = date, y = close)) +
  geom_line(aes(col = symbol)) +
  theme_tq(base_family = "Lato") +
  scale_x_date(labels = scales::date_format("%m-%Y"), date_breaks = "6 months") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(legend.text = element_text()) +
  ylab("Daily Closing Value (USD)")
```

### Having a closer look

We see a fairly volatile situation, although it appears at a glance that the daily closing values are increasing over time. Another useful tool within the ```tidyquant::tq_get()``` library is the ```key.ratios()``` function. The output of this function produces an impressively structured data frame (tibble in fact) of key statistics from each company. This time, I'll limit the date to after 2014.

```{r, cache=TRUE, warning=FALSE}
weed_key_ratios <- tq_get(c("GWPH", "IIPR", "INSY", "SMG",
                            "XXII","ZYNE", "CGC", "APHQF", "CRON"), 
                          get = "key.ratios", from = "2014-01-01")
```






